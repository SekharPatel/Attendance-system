{% extends "base.html" %}

{% block title %}Manage Attendance{% endblock %}

{% block head %}
<link href="{{ url_for('static', filename='css/attendance.css') }}" rel="stylesheet">
{% endblock %}

{% block page_title %}Manage Attendance{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active">Manage Attendance</li>
{% endblock %}

{% block content %}
<!-- Statistics Panel -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stats-card stats-success">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="stats-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stats-content">
                        <h3 class="stats-number">{{ attendance_stats.present }}</h3>
                        <p class="stats-label">Present</p>
                        <small class="stats-percentage">{{ attendance_stats.present_percentage }}%</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card stats-warning">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="stats-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stats-content">
                        <h3 class="stats-number">{{ attendance_stats.late }}</h3>
                        <p class="stats-label">Late</p>
                        <small class="stats-percentage">{{ attendance_stats.late_percentage }}%</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card stats-danger">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="stats-icon">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <div class="stats-content">
                        <h3 class="stats-number">{{ attendance_stats.absent }}</h3>
                        <p class="stats-label">Absent</p>
                        <small class="stats-percentage">{{ attendance_stats.absent_percentage }}%</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card stats-primary">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="stats-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <div class="stats-content">
                        <h3 class="stats-number">{{ attendance_stats.total }}</h3>
                        <p class="stats-label">Total Records</p>
                        <small class="stats-percentage">100%</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filter and Action Bar -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" id="filterForm" class="row g-3">
            <!-- Multi-level Filters -->
            <div class="col-md-2">
                <label for="semesterFilter" class="form-label">Semester</label>
                <select class="form-select" id="semesterFilter" name="semester" onchange="updateCourseFilter()">
                    <option value="">All Semesters</option>
                    {% for semester_stat in semester_stats %}
                    <option value="{{ semester_stat.semester }}" 
                            {{ 'selected' if current_filters.semester == semester_stat.semester else '' }}>
                        Semester {{ semester_stat.semester }} ({{ semester_stat.count }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-2">
                <label for="courseFilter" class="form-label">Course</label>
                <select class="form-select" id="courseFilter" name="course">
                    <option value="">All Courses</option>
                    {% for course in courses_with_attendance %}
                    <option value="{{ course.id }}" 
                            data-semester="{{ course.semester }}"
                            {{ 'selected' if current_filters.course == course.id else '' }}>
                        {{ course.course_code }} ({{ course.count }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-2">
                <label for="dateFrom" class="form-label">Date From</label>
                <input type="date" class="form-control" id="dateFrom" name="date_from" 
                       value="{{ current_filters.date_from or '' }}">
            </div>
            
            <div class="col-md-2">
                <label for="dateTo" class="form-label">Date To</label>
                <input type="date" class="form-control" id="dateTo" name="date_to" 
                       value="{{ current_filters.date_to or '' }}">
            </div>
            
            <div class="col-md-2">
                <label for="statusFilter" class="form-label">Status</label>
                <select class="form-select" id="statusFilter" name="status">
                    <option value="">All Status</option>
                    <option value="present" {{ 'selected' if current_filters.status == 'present' else '' }}>Present</option>
                    <option value="late" {{ 'selected' if current_filters.status == 'late' else '' }}>Late</option>
                    <option value="absent" {{ 'selected' if current_filters.status == 'absent' else '' }}>Absent</option>
                </select>
            </div>
            
            <div class="col-md-2">
                <label for="searchQuery" class="form-label">Search</label>
                <input type="text" class="form-control" id="searchQuery" name="search" 
                       placeholder="Student or course..." value="{{ current_filters.search or '' }}">
            </div>
            
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search me-2"></i>Apply Filters
                        </button>
                        <a href="{{ url_for('admin.attendance_records') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-2"></i>Clear
                        </a>
                    </div>
                    
                    <div class="btn-group">
                        <!-- View Toggle -->
                        <input type="hidden" name="view" id="viewType" value="{{ current_filters.view or 'table' }}">
                        <button type="button" class="btn btn-outline-primary {{ 'active' if current_filters.view != 'calendar' else '' }}" 
                                onclick="switchView('table')">
                            <i class="fas fa-table me-2"></i>Table View
                        </button>
                        <button type="button" class="btn btn-outline-primary {{ 'active' if current_filters.view == 'calendar' else '' }}" 
                                onclick="switchView('calendar')">
                            <i class="fas fa-calendar me-2"></i>Calendar View
                        </button>
                        
                        <!-- Action Buttons -->
                        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addAttendanceModal">
                            <i class="fas fa-plus me-2"></i>Add Attendance
                        </button>
                        <button type="button" class="btn btn-outline-primary" onclick="exportRecords()">
                            <i class="fas fa-download me-2"></i>Export
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Table View -->
{% if current_filters.view != 'calendar' %}
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Attendance Records</h5>
            <div class="bulk-actions" id="bulkActions" style="display: none;">
                <div class="btn-group">
                    <button class="btn btn-sm btn-success" onclick="bulkUpdateStatus('present')">
                        <i class="fas fa-check me-1"></i>Mark Present
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="bulkUpdateStatus('late')">
                        <i class="fas fa-clock me-1"></i>Mark Late
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="bulkUpdateStatus('absent')">
                        <i class="fas fa-times me-1"></i>Mark Absent
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="bulkDelete()">
                        <i class="fas fa-trash me-1"></i>Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                        </th>
                        <th>Date</th>
                        <th>Student</th>
                        <th>Course</th>
                        <th>Check In</th>
                        <th>Check Out</th>
                        <th>Status</th>
                        <th>Method</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in records.items %}
                    <tr>
                        <td>
                            <input type="checkbox" class="record-checkbox" value="{{ record.id }}" 
                                   onchange="updateBulkActions()">
                        </td>
                        <td>{{ record.check_in_time.strftime('%Y-%m-%d') }}</td>
                        <td>
                            <div class="student-info">
                                <strong>{{ record.student.full_name }}</strong>
                                <br><small class="text-muted">{{ record.student.student_id }} | Semester {{ record.student.semester }}</small>
                            </div>
                        </td>
                        <td>
                            <div class="course-info">
                                <strong>{{ record.class_session.course.course_code }}</strong>
                                <br><small class="text-muted">{{ record.class_session.course.course_name }}</small>
                            </div>
                        </td>
                        <td>{{ record.check_in_time.strftime('%H:%M:%S') }}</td>
                        <td>{{ record.check_out_time.strftime('%H:%M:%S') if record.check_out_time else 'N/A' }}</td>
                        <td>
                            <span class="badge bg-{{ 'success' if record.status == 'present' else 'warning' if record.status == 'late' else 'danger' }}">
                                {{ record.status.title() }}
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-{{ 'primary' if record.method == 'nfc' else 'info' if record.method == 'manual' else 'secondary' }}">
                                {{ record.method.upper() }}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editAttendance({{ record.id }})" 
                                        title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteAttendance({{ record.id }})" 
                                        title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="9" class="text-center py-4">
                            <i class="fas fa-search fa-2x text-muted mb-2"></i>
                            <p class="text-muted">No attendance records found matching your criteria.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if records.pages > 1 %}
        <nav aria-label="Attendance records pagination">
            <ul class="pagination justify-content-center">
                {% if records.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('admin.attendance_records', 
                            page=records.prev_num,
                            semester=current_filters.semester,
                            course=current_filters.course,
                            date_from=current_filters.date_from,
                            date_to=current_filters.date_to,
                            status=current_filters.status,
                            search=current_filters.search,
                            view=current_filters.view) }}">Previous</a>
                    </li>
                {% endif %}
                
                {% for page_num in records.iter_pages() %}
                    {% if page_num %}
                        {% if page_num != records.page %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('admin.attendance_records', 
                                    page=page_num,
                                    semester=current_filters.semester,
                                    course=current_filters.course,
                                    date_from=current_filters.date_from,
                                    date_to=current_filters.date_to,
                                    status=current_filters.status,
                                    search=current_filters.search,
                                    view=current_filters.view) }}">{{ page_num }}</a>
                            </li>
                        {% else %}
                            <li class="page-item active">
                                <span class="page-link">{{ page_num }}</span>
                            </li>
                        {% endif %}
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% endif %}
                {% endfor %}
                
                {% if records.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('admin.attendance_records', 
                            page=records.next_num,
                            semester=current_filters.semester,
                            course=current_filters.course,
                            date_from=current_filters.date_from,
                            date_to=current_filters.date_to,
                            status=current_filters.status,
                            search=current_filters.search,
                            view=current_filters.view) }}">Next</a>
                    </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Calendar View -->
{% if current_filters.view == 'calendar' %}
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">Attendance Calendar</h5>
    </div>
    <div class="card-body">
        <div id="attendanceCalendar" class="calendar-container">
            {% if calendar_data %}
                <div class="calendar-grid">
                    {% for day_data in calendar_data %}
                    <div class="calendar-day" data-date="{{ day_data.date }}">
                        <div class="calendar-date">{{ day_data.date.split('-')[2] }}</div>
                        <div class="calendar-stats">
                            <div class="stat-item stat-present">
                                <span class="stat-count">{{ day_data.present }}</span>
                                <span class="stat-label">P</span>
                            </div>
                            <div class="stat-item stat-late">
                                <span class="stat-count">{{ day_data.late }}</span>
                                <span class="stat-label">L</span>
                            </div>
                            <div class="stat-item stat-absent">
                                <span class="stat-count">{{ day_data.absent }}</span>
                                <span class="stat-label">A</span>
                            </div>
                        </div>
                        <div class="calendar-total">Total: {{ day_data.total }}</div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-calendar fa-2x text-muted mb-2"></i>
                    <p class="text-muted">No attendance data found for the selected date range.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

<!-- Add Attendance Modal -->
<div class="modal fade" id="addAttendanceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Attendance Record</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addAttendanceForm">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="addSemester" class="form-label">Semester</label>
                            <select class="form-select" id="addSemester" name="semester" required onchange="updateAddCourseOptions()">
                                <option value="">Select Semester</option>
                                {% for i in range(1, 9) %}
                                <option value="{{ i }}">Semester {{ i }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="addCourse" class="form-label">Course</label>
                            <select class="form-select" id="addCourse" name="course_id" required onchange="updateAddStudentOptions()">
                                <option value="">Select Course</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="addStudent" class="form-label">Student</label>
                            <select class="form-select" id="addStudent" name="student_id" required>
                                <option value="">Select Student</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="addStatus" class="form-label">Status</label>
                            <select class="form-select" id="addStatus" name="status" required>
                                <option value="present">Present</option>
                                <option value="late">Late</option>
                                <option value="absent">Absent</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="addDate" class="form-label">Date</label>
                            <input type="date" class="form-control" id="addDate" name="date" required>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="addTime" class="form-label">Time</label>
                            <input type="time" class="form-control" id="addTime" name="time" value="09:00">
                        </div>
                        
                        <div class="col-12">
                            <label for="addNotes" class="form-label">Notes (Optional)</label>
                            <textarea class="form-control" id="addNotes" name="notes" rows="2"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Attendance</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Global variables
let allCourses = {{ courses_json | tojson }};
let allStudents = {{ students_json | tojson }};

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Set today's date as default
    document.getElementById('addDate').value = new Date().toISOString().split('T')[0];
    
    // Update course filter based on current semester selection
    updateCourseFilter();
});

// Filter functions
function updateCourseFilter() {
    const semesterSelect = document.getElementById('semesterFilter');
    const courseSelect = document.getElementById('courseFilter');
    const selectedSemester = semesterSelect.value;
    
    // Clear current options except "All Courses"
    courseSelect.innerHTML = '<option value="">All Courses</option>';
    
    // Add courses for selected semester
    const courseOptions = document.querySelectorAll('#courseFilter option[data-semester]');
    courseOptions.forEach(option => {
        if (!selectedSemester || option.dataset.semester === selectedSemester) {
            option.style.display = 'block';
        } else {
            option.style.display = 'none';
        }
    });
}

function switchView(viewType) {
    document.getElementById('viewType').value = viewType;
    document.getElementById('filterForm').submit();
}

// Add attendance modal functions
function updateAddCourseOptions() {
    const semesterSelect = document.getElementById('addSemester');
    const courseSelect = document.getElementById('addCourse');
    const selectedSemester = parseInt(semesterSelect.value);
    
    courseSelect.innerHTML = '<option value="">Select Course</option>';
    
    if (selectedSemester) {
        allCourses.forEach(course => {
            if (course.semester === selectedSemester) {
                const option = document.createElement('option');
                option.value = course.id;
                option.textContent = `${course.course_code} - ${course.course_name}`;
                courseSelect.appendChild(option);
            }
        });
    }
    
    // Clear student selection
    document.getElementById('addStudent').innerHTML = '<option value="">Select Student</option>';
}

function updateAddStudentOptions() {
    const semesterSelect = document.getElementById('addSemester');
    const studentSelect = document.getElementById('addStudent');
    const selectedSemester = parseInt(semesterSelect.value);
    
    studentSelect.innerHTML = '<option value="">Select Student</option>';
    
    if (selectedSemester) {
        allStudents.forEach(student => {
            if (student.semester === selectedSemester) {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.full_name} (${student.student_id})`;
                studentSelect.appendChild(option);
            }
        });
    }
}

// Form submission
document.getElementById('addAttendanceForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    
    fetch('/admin/api/attendance/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while adding attendance');
    });
});

// Bulk operations
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.record-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
    
    updateBulkActions();
}

function updateBulkActions() {
    const checkboxes = document.querySelectorAll('.record-checkbox:checked');
    const bulkActions = document.getElementById('bulkActions');
    
    if (checkboxes.length > 0) {
        bulkActions.style.display = 'block';
    } else {
        bulkActions.style.display = 'none';
    }
}

function getSelectedIds() {
    const checkboxes = document.querySelectorAll('.record-checkbox:checked');
    return Array.from(checkboxes).map(cb => parseInt(cb.value));
}

function bulkUpdateStatus(status) {
    const selectedIds = getSelectedIds();
    
    if (selectedIds.length === 0) {
        alert('Please select attendance records to update');
        return;
    }
    
    if (!confirm(`Are you sure you want to mark ${selectedIds.length} records as ${status}?`)) {
        return;
    }
    
    fetch('/admin/api/attendance/bulk-update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            attendance_ids: selectedIds,
            action: 'update_status',
            status: status
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred during bulk update');
    });
}

function bulkDelete() {
    const selectedIds = getSelectedIds();
    
    if (selectedIds.length === 0) {
        alert('Please select attendance records to delete');
        return;
    }
    
    if (!confirm(`Are you sure you want to delete ${selectedIds.length} attendance records? This action cannot be undone.`)) {
        return;
    }
    
    fetch('/admin/api/attendance/bulk-update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            attendance_ids: selectedIds,
            action: 'delete'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred during bulk delete');
    });
}

// Individual record actions
function editAttendance(id) {
    // TODO: Implement edit functionality
    alert('Edit functionality to be implemented');
}

function deleteAttendance(id) {
    if (!confirm('Are you sure you want to delete this attendance record?')) {
        return;
    }
    
    fetch('/admin/api/attendance/bulk-update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            attendance_ids: [id],
            action: 'delete'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while deleting attendance record');
    });
}

function exportRecords() {
    // TODO: Implement export functionality
    alert('Export functionality to be implemented');
}
</script>
{% endblock %}
